<!DOCTYPE html>
<html>
<head>
  <title>AI-Enhanced SQL Tutor with OpenRouter</title>
  <meta charset="UTF-8">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    /* (Keep all your existing styles from previous implementation) */
    .button-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
    }

    textarea {
      width: 100%;
      margin-top: 5px;
      font-family: monospace;
      font-size: 1rem;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .collapsible {
      background-color: #f1f1f1;
      color: #000;
      cursor: pointer;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      transition: background-color 0.3s;
    }

    .collapsible:hover {
      background-color: #ddd;
    }

    .hint-content {
      display: none;
      padding: 10px;
      margin-top: 5px;
      background-color: #e8f4ff;
      border-left: 4px solid #2196F3;
      border-radius: 0 4px 4px 0;
    }
    
    button.collapsible.active + .hint-content {
      display: block;
    }

    .feedback {
      margin: 10px 0;
      padding: 10px;
      border-radius: 4px;
      transition: all 0.3s ease;
    }

    .feedback.correct {
      background-color: #e6f7e6;
      border-left: 4px solid #4CAF50;
    }

    .feedback.incorrect {
      background-color: #ffebee;
      border-left: 4px solid #F44336;
    }

    .feedback.loading {
      background-color: #e3f2fd;
      border-left: 4px solid #2196F3;
    }

    .feedback.error {
      background-color: #fff3e0;
      border-left: 4px solid #FF9800;
    }

    .sql-keyword {
      color: #0077cc;
      font-weight: bold;
    }

    .api-key-container {
      margin: 20px 0;
      padding: 15px;
      background-color: #f5f5f5;
      border-radius: 5px;
    }

    .api-key-input {
      width: 300px;
      padding: 8px;
      margin-right: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .model-selector {
      padding: 8px;
      margin-left: 10px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
  </style>
</head>
<body>

<div class="api-key-container">
  <h3>OpenRouter Configuration</h3>
  <input type="password" class="api-key-input" placeholder="Enter OpenRouter API Key">
  <select class="model-selector">
    <option value="openai/gpt-3.5-turbo">GPT-3.5 Turbo</option>
    <option value="anthropic/claude-3-haiku">Claude 3 Haiku</option>
    <option value="google/gemini-pro">Gemini Pro</option>
    <option value="mistralai/mistral-7b-instruct">Mistral 7B</option>
  </select>
  <button onclick="saveConfig()">Save Settings</button>
  <p><small>Your API key is stored locally in your browser only.</small></p>
</div>

<h1>Activity 4E: CAR Database (AI Enhanced)</h1>

<!-- (Keep all your existing database tables and schema display) -->

<!-- QUESTIONS -->
<ol>
  <li>
    <p><b>Type SQL command to create table CUSTOMER.</b></p>
    <textarea rows="3" placeholder="Write your SQL here..."></textarea>
    <div class="button-row">
      <button class="collapsible">üí° Show Hint</button>
      <button onclick="checkAnswer(this, 'CREATE TABLE statement for CUSTOMER', ['create table customer (custid varchar(5) primary key, custname varchar(100), car_number varchar(10), phone_number varchar(15), register_date date);'])">Check Answer</button>
    </div>
    <div class="feedback"></div>
    <div class="hint-content">
      Use <span class="sql-keyword">CREATE TABLE</span> with correct syntax for column names and types.
      <br><br>Example:
      <pre><code>CREATE TABLE customer (
  custid VARCHAR(5) PRIMARY KEY,
  custname VARCHAR(100),
  car_number VARCHAR(10),
  phone_number VARCHAR(15),
  register_date DATE
);</code></pre>
    </div>
  </li>

  <!-- Additional questions follow same pattern -->
  <li>
    <p><b>Type SQL command to insert all data into CUSTOMER table.</b></p>
    <textarea rows="6" placeholder="Write your SQL here..."></textarea>
    <div class="button-row">
      <button class="collapsible">üí° Show Hint</button>
      <button onclick="checkAnswer(this, 'INSERT statement for CUSTOMER data', ['insert into customer values (\'c0001\', \'david teo\', \'wuv2318\', \'81691\', \'2014-01-09\');'])">Check Answer</button>
    </div>
    <div class="feedback"></div>
    <div class="hint-content">
      Use the <span class="sql-keyword">INSERT INTO table_name VALUES (...)</span> syntax and follow the column order exactly as defined in the schema.
    </div>
  </li>

  <!-- Remaining questions would follow the same pattern -->
</ol>

<script>
// Configuration
const CONFIG = {
  enableAI: true,
  fallbackToBasic: true,
  openRouterEndpoint: 'https://openrouter.ai/api/v1/chat/completions',
  defaultModel: 'openai/gpt-3.5-turbo'
};

// Store correct answers for fallback validation
const correctAnswersMap = {
  'CREATE TABLE statement for CUSTOMER': [
    'create table customer (custid varchar(5) primary key, custname varchar(100), car_number varchar(10), phone_number varchar(15), register_date date);'
  ],
  'INSERT statement for CUSTOMER data': [
    'insert into customer values (\'c0001\', \'david teo\', \'wuv2318\', \'81691\', \'2014-01-09\');'
  ]
  // Add more as needed
};

// Initialize settings
function loadConfig() {
  const savedKey = localStorage.getItem('openrouter_key');
  const savedModel = localStorage.getItem('ai_model');
  
  if (savedKey) {
    document.querySelector('.api-key-input').value = savedKey;
  }
  
  if (savedModel) {
    document.querySelector('.model-selector').value = savedModel;
  }
}

function saveConfig() {
  const apiKey = document.querySelector('.api-key-input').value.trim();
  const model = document.querySelector('.model-selector').value;
  
  if (apiKey) {
    localStorage.setItem('openrouter_key', apiKey);
    localStorage.setItem('ai_model', model);
    alert('Configuration saved successfully!');
  } else {
    alert('Please enter your OpenRouter API key');
  }
}

async function checkAnswer(button, questionType, fallbackAnswers) {
  const container = button.closest('li');
  const textarea = container.querySelector("textarea");
  const feedback = container.querySelector(".feedback");
  const userAnswer = textarea.value.trim();
  
  // Store fallback answers
  if (fallbackAnswers) {
    correctAnswersMap[questionType] = fallbackAnswers;
  }

  // Show loading state
  feedback.innerHTML = "‚è≥ Analyzing your answer...";
  feedback.className = "feedback loading";

  try {
    let evaluation;
    
    if (CONFIG.enableAI) {
      try {
        evaluation = await evaluateWithOpenRouter(userAnswer, questionType);
      } catch (aiError) {
        console.error("AI Error:", aiError);
        if (CONFIG.fallbackToBasic) {
          evaluation = await fallbackValidation(userAnswer, questionType);
        } else {
          throw aiError;
        }
      }
    } else {
      evaluation = await fallbackValidation(userAnswer, questionType);
    }

    // Display results
    feedback.innerHTML = evaluation.isCorrect 
      ? `‚úÖ <strong>Correct!</strong> ${evaluation.explanation || ''}`
      : `‚ùå <strong>Needs improvement:</strong> ${evaluation.feedback || 'Try again.'}${evaluation.hint ? '<br><br>üí° <strong>Hint:</strong> ' + evaluation.hint : ''}`;
    
    feedback.className = evaluation.isCorrect ? "feedback correct" : "feedback incorrect";
    
  } catch (error) {
    console.error("Validation Error:", error);
    feedback.innerHTML = "‚ö†Ô∏è <strong>Error:</strong> Could not validate your answer. Please try again later.";
    feedback.className = "feedback error";
  }
}

async function evaluateWithOpenRouter(sql, questionType) {
  const apiKey = localStorage.getItem('openrouter_key');
  const model = localStorage.getItem('ai_model') || CONFIG.defaultModel;
  
  if (!apiKey) {
    throw new Error("OpenRouter API key not configured");
  }

  const prompt = `You are a SQL tutor evaluating a student's answer to the question: "${questionType}".
  
Database Schema:
CUSTOMER(CUSTID, CUSTNAME, CAR_NUMBER, PHONE_NUMBER, REGISTER_DATE)
CAR_COMPONENT(COMPID, COMPNAME, PRICE)
CLAIM(CLAIMID, CLAIM_DATE, CUSTID)
COMPONENT_CLAIM(CLAIMID, COMPID, QUANTITY)

Student's SQL:
${sql}

Evaluate for:
1. Syntax correctness
2. Logical correctness for the question
3. Semantic equivalence to correct solutions
4. Provide specific feedback if wrong
5. Suggest a helpful hint if wrong
6. Keep responses concise and educational
7. Return response in JSON format

Respond with ONLY the JSON object like this:
{
  "isCorrect": boolean,
  "explanation": string,
  "feedback": string,
  "hint": string
}`;

  const response = await axios.post(
    CONFIG.openRouterEndpoint,
    {
      model: model,
      messages: [{ role: "user", content: prompt }],
      temperature: 0.3
    },
    {
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`,
        'HTTP-Referer': window.location.href,
        'X-Title': 'SQL AI Tutor'
      }
    }
  );

  // Extract JSON from response
  const responseText = response.data.choices[0].message.content;
  const jsonStart = responseText.indexOf('{');
  const jsonEnd = responseText.lastIndexOf('}') + 1;
  const jsonString = responseText.slice(jsonStart, jsonEnd);
  
  return JSON.parse(jsonString);
}

async function fallbackValidation(userAnswer, questionType) {
  const normalizedUser = userAnswer.toLowerCase()
    .replace(/\s+/g, ' ')
    .replace(/;/g, '')
    .trim();
  
  const correctAnswers = correctAnswersMap[questionType] || [];
  const normalizedCorrect = correctAnswers.map(ans => 
    ans.toLowerCase().replace(/\s+/g, ' ').replace(/;/g, '').trim()
  );

  const isCorrect = normalizedCorrect.includes(normalizedUser);
  
  return {
    isCorrect,
    feedback: isCorrect ? '' : 'Your answer doesn\'t match the expected solution.',
    hint: isCorrect ? '' : `Try: ${correctAnswers[0]}`,
    explanation: isCorrect ? 'Your SQL syntax looks correct!' : ''
  };
}

// Toggle hints
document.addEventListener('DOMContentLoaded', () => {
  loadConfig();
  
  const collabs = document.querySelectorAll(".collapsible");
  collabs.forEach(btn => {
    btn.addEventListener("click", function() {
      this.classList.toggle("active");
      const content = this.nextElementSibling;
      content.style.display = content.style.display === "block" ? "none" : "block";
    });
  });
});
</script>
</body>
</html>
