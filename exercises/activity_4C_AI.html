<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SQL Learning - Activity 4C</title>
  <style>
    :root {
      --primary: #3498db;
      --secondary: #2c3e50;
      --success: #2ecc71;
      --danger: #e74c3c;
      --light: #f5f7fa;
      --dark: #333;
      --gray: #7f8c8d;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 0;
      color: var(--dark);
      background-color: var(--light);
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: var(--secondary);
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }

    .header h1 {
      margin: 0;
      font-size: 1.5rem;
    }

    .header p {
      margin: 0;
      opacity: 0.8;
      font-size: 0.9rem;
    }

    .nav-links a {
      color: white;
      text-decoration: none;
      margin-left: 1rem;
      padding: 0.5rem;
      border-radius: 4px;
      transition: background 0.3s;
    }

    .nav-links a:hover {
      background: rgba(255,255,255,0.1);
    }

    h2 {
      color: var(--secondary);
      border-bottom: 2px solid var(--primary);
      padding-bottom: 8px;
      margin-top: 30px;
    }

    .activity-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 15px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .activity-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .table-header {
      font-weight: bold;
      margin-bottom: 10px;
      color: var(--secondary);
    }

    textarea {
      width: 100%;
      min-height: 120px;
      font-family: 'Consolas', 'Monaco', monospace;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 4px;
      resize: vertical;
      font-size: 14px;
      margin: 10px 0;
      background: #f8f9fa;
      transition: border-color 0.3s;
    }

    textarea:focus {
      border-color: var(--primary);
      outline: none;
    }

    .button-row {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      margin: 15px 0;
      flex-wrap: wrap;
      gap: 10px;
    }

    .btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .btn:hover {
      background: #2980b9;
      transform: translateY(-2px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: var(--gray);
    }

    .feedback {
      padding: 12px;
      margin: 15px 0;
      border-radius: 4px;
      border-left: 4px solid var(--primary);
      animation: fadeIn 0.3s ease-in;
    }

    .feedback-success {
      border-color: var(--success);
      background: #e8f8f0;
    }

    .feedback-error {
      border-color: var(--danger);
      background: #fdedec;
    }

    .loading {
      color: var(--gray);
      font-style: italic;
    }

    .sql-keyword {
      color: #d03b3b;
      font-weight: bold;
    }

    .grade {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .grade-A { color: var(--success); }
    .grade-B { color: #27ae60; }
    .grade-C { color: #f39c12; }
    .grade-D { color: #e67e22; }
    .grade-F { color: var(--danger); }

    .feedback-item {
      margin-bottom: 8px;
      padding-left: 24px;
      position: relative;
    }

    .feedback-item:before {
      position: absolute;
      left: 0;
      top: 2px;
    }

    .correct:before {
      content: "‚úÖ";
    }

    .warning:before {
      content: "‚ö†Ô∏è";
    }

    .error:before {
      content: "‚ùå";
    }

    .suggestion:before {
      content: "üí°";
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        text-align: center;
      }
      
      .nav-links {
        margin-top: 1rem;
      }
      
      .nav-links a {
        margin: 0 0.5rem;
      }
      
      .button-row {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">
      <h1>üìò AI-Augmented SQL Learning</h1>
      <p>Interactive CREATE TABLE Statements Practice</p>
    </div>
    <div class="nav-links">
      <a href="https://norshaab.github.io/sql-ai-ebook/">Home</a>
      <a href="activity_AI.html">Exercise 4E</a>
    </div>
  </div>

  <div class="container">
    <h2>Activity 4C: CREATE TABLE Statements</h2>
    
    <div class="activity-card">
      <div class="table-header">a. Branch (<span class="sql-keyword">branchNo</span>, street, city, postcode)</div>
      <textarea id="sqlBranch" placeholder="CREATE TABLE Branch (
  branchNo VARCHAR(5) PRIMARY KEY,
  street VARCHAR(100) NOT NULL,
  city VARCHAR(50) NOT NULL,
  postcode VARCHAR(10) NOT NULL
);"></textarea>
      <div class="button-row">
        <button onclick="checkSQL('sqlBranch', 'feedbackBranch')">
          <span>üîç</span> Check Branch
        </button>
        <button class="btn-secondary" onclick="showSolution('branch')">
          <span>üí°</span> Show Solution
        </button>
      </div>
      <div id="feedbackBranch" class="feedback"></div>
    </div>

    <div class="activity-card">
      <div class="table-header">b. Staff (<span class="sql-keyword">staffNo</span>, fName, lName, position, gender, DOB, salary, <span class="sql-keyword">branchNo</span>)</div>
      <textarea id="sqlStaff" placeholder="CREATE TABLE Staff (
  staffNo VARCHAR(5) PRIMARY KEY,
  fName VARCHAR(50) NOT NULL,
  lName VARCHAR(50) NOT NULL,
  /* ... */
);"></textarea>
      <div class="button-row">
        <button onclick="checkSQL('sqlStaff', 'feedbackStaff')">
          <span>üîç</span> Check Staff
        </button>
        <button class="btn-secondary" onclick="showSolution('staff')">
          <span>üí°</span> Show Solution
        </button>
      </div>
      <div id="feedbackStaff" class="feedback"></div>
    </div>

    <div class="activity-card">
      <div class="table-header">c. PropertyForRent (<span class="sql-keyword">propertyNo</span>, type, rooms, rent, <span class="sql-keyword">ownerNo</span>, <span class="sql-keyword">staffNo</span>, <span class="sql-keyword">branchNo</span>)</div>
      <textarea id="sqlProperty" placeholder="CREATE TABLE PropertyForRent (
  propertyNo VARCHAR(5) PRIMARY KEY,
  /* ... */
);"></textarea>
      <div class="button-row">
        <button onclick="checkSQL('sqlProperty', 'feedbackProperty')">
          <span>üîç</span> Check Property
        </button>
        <button class="btn-secondary" onclick="showSolution('property')">
          <span>üí°</span> Show Solution
        </button>
      </div>
      <div id="feedbackProperty" class="feedback"></div>
    </div>

    <div class="activity-card">
      <div class="table-header">d. Client (<span class="sql-keyword">clientNo</span>, fName, lName, telNo, prefType, maxRent, email)</div>
      <textarea id="sqlClient" placeholder="CREATE TABLE Client (
  clientNo VARCHAR(5) PRIMARY KEY,
  /* ... */
);"></textarea>
      <div class="button-row">
        <button onclick="checkSQL('sqlClient', 'feedbackClient')">
          <span>üîç</span> Check Client
        </button>
        <button class="btn-secondary" onclick="showSolution('client')">
          <span>üí°</span> Show Solution
        </button>
      </div>
      <div id="feedbackClient" class="feedback"></div>
    </div>

    <div class="activity-card">
      <div class="table-header">e. PrivateOwner (<span class="sql-keyword">ownerNo</span>, fName, lName, address, telNo, email, password)</div>
      <textarea id="sqlOwner" placeholder="CREATE TABLE PrivateOwner (
  ownerNo VARCHAR(5) PRIMARY KEY,
  /* ... */
);"></textarea>
      <div class="button-row">
        <button onclick="checkSQL('sqlOwner', 'feedbackOwner')">
          <span>üîç</span> Check Owner
        </button>
        <button class="btn-secondary" onclick="showSolution('owner')">
          <span>üí°</span> Show Solution
        </button>
      </div>
      <div id="feedbackOwner" class="feedback"></div>
    </div>

    <div class="activity-card">
      <div class="table-header">f. Viewing (<span class="sql-keyword">clientNo</span>, <span class="sql-keyword">propertyNo</span>, viewDate, comments)</div>
      <textarea id="sqlViewing" placeholder="CREATE TABLE Viewing (
  /* Composite key? Foreign keys? */
);"></textarea>
      <div class="button-row">
        <button onclick="checkSQL('sqlViewing', 'feedbackViewing')">
          <span>üîç</span> Check Viewing
        </button>
        <button class="btn-secondary" onclick="showSolution('viewing')">
          <span>üí°</span> Show Solution
        </button>
      </div>
      <div id="feedbackViewing" class="feedback"></div>
    </div>
  </div>

  <script>
  async function checkSQL(textareaId, feedbackId) {
    const sql = document.getElementById(textareaId).value.trim();
    const feedbackBox = document.getElementById(feedbackId);
    const tableHeader = document.querySelector(`#${textareaId}`).previousElementSibling.textContent;
    
    if (!sql) {
      feedbackBox.innerHTML = "<span class='error'>‚ùå Please enter SQL first</span>";
      feedbackBox.className = "feedback feedback-error";
      return;
    }

    feedbackBox.innerHTML = "<span class='loading'>‚è≥ Analyzing with AI...</span>";
    feedbackBox.className = "feedback";
    
    try {
      const response = await fetch("https://openrouter-proxy-k2ca.onrender.com/ai", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          messages: [
            {
              role: "user",
              content: `Analyze this SQL CREATE TABLE statement against these exact requirements: ${tableHeader}. 
              Focus STRICTLY on whether it matches the required structure - don't suggest adding columns not in requirements.
              Check for:
              1. All required columns present
              2. Correct data types
              3. Proper PRIMARY KEY definition
              4. Appropriate constraints
              5. Correct syntax
              
              If everything matches requirements perfectly, give Grade A.
              If minor issues, give Grade B.
              If major issues, give Grade C or below.
              
              Format response with MAX 5 bullet points (EMOJI + brief comment).
              End with Grade: X.
              
              Example perfect response:
              ‚úÖ All required columns present
              ‚úÖ Correct data types used
              ‚úÖ Proper PRIMARY KEY definition
              ‚úÖ Appropriate NOT NULL constraints
              ‚úÖ Syntax is correct
              
              Grade: A
              
              SQL to analyze:
              ${sql}`
            }
          ]
        })
      });

      if (!response.ok) {
        throw new Error(`Server error: ${response.status}`);
      }

      const data = await response.json();
      let aiResponse = data.choices?.[0]?.message?.content || "No analysis available";
      
      // Post-process the AI response to remove unwanted suggestions
      aiResponse = aiResponse.replace(/üí°.*(add|consider).*(column|index|field).*/gi, '');
      aiResponse = aiResponse.replace(/\n\s*\n/g, '\n'); // Remove empty lines
      
      // Format the response
      const gradeMatch = aiResponse.match(/Grade: ([A-F])/i);
      const grade = gradeMatch ? gradeMatch[1] : '?';
      let feedbackContent = aiResponse.replace(/Grade: [A-F]/i, '').trim();
      
      // Ensure we don't show empty suggestions
      feedbackContent = feedbackContent.split('\n')
        .filter(line => line.trim().length > 0)
        .join('\n');
      
      feedbackBox.innerHTML = `
        <div class="grade grade-${grade}">Grade: ${grade}</div>
        ${feedbackContent.split('\n').map(line => {
          if (line.includes('‚úÖ')) return `<div class="feedback-item correct">${line}</div>`;
          if (line.includes('‚ö†Ô∏è')) return `<div class="feedback-item warning">${line}</div>`;
          if (line.includes('‚ùå')) return `<div class="feedback-item error">${line}</div>`;
          if (line.includes('üí°') && !line.toLowerCase().includes('add') && !line.toLowerCase().includes('consider')) {
            return `<div class="feedback-item suggestion">${line}</div>`;
          }
          return line.trim() ? `<div>${line}</div>` : '';
        }).join('')}
      `;
      feedbackBox.className = "feedback";
    } catch (error) {
      feedbackBox.innerHTML = `<div class="error">‚ùå Error: ${error.message || "Failed to get AI response"}</div>`;
      feedbackBox.className = "feedback feedback-error";
    }
  }

  async function showSolution(tableType) {
    const solutions = {
      branch: "CREATE TABLE Branch (\n  branchNo VARCHAR(5) PRIMARY KEY,\n  street VARCHAR(100) NOT NULL,\n  city VARCHAR(50) NOT NULL,\n  postcode VARCHAR(10) NOT NULL\n);",
      staff: "CREATE TABLE Staff (\n  staffNo VARCHAR(5) PRIMARY KEY,\n  fName VARCHAR(50) NOT NULL,\n  lName VARCHAR(50) NOT NULL,\n  position VARCHAR(20) NOT NULL,\n  gender CHAR(1) CHECK (gender IN ('M', 'F')),\n  DOB DATE NOT NULL,\n  salary DECIMAL(10,2) NOT NULL,\n  branchNo VARCHAR(5) NOT NULL,\n  FOREIGN KEY (branchNo) REFERENCES Branch(branchNo)\n);",
      property: "CREATE TABLE PropertyForRent (\n  propertyNo VARCHAR(5) PRIMARY KEY,\n  type VARCHAR(20) NOT NULL,\n  rooms INT NOT NULL,\n  rent DECIMAL(10,2) NOT NULL,\n  ownerNo VARCHAR(5) NOT NULL,\n  staffNo VARCHAR(5),\n  branchNo VARCHAR(5) NOT NULL,\n  FOREIGN KEY (ownerNo) REFERENCES PrivateOwner(ownerNo),\n  FOREIGN KEY (staffNo) REFERENCES Staff(staffNo),\n  FOREIGN KEY (branchNo) REFERENCES Branch(branchNo)\n);",
      client: "CREATE TABLE Client (\n  clientNo VARCHAR(5) PRIMARY KEY,\n  fName VARCHAR(50) NOT NULL,\n  lName VARCHAR(50) NOT NULL,\n  telNo VARCHAR(15) NOT NULL,\n  prefType VARCHAR(20),\n  maxRent DECIMAL(10,2),\n  email VARCHAR(100)\n);",
      owner: "CREATE TABLE PrivateOwner (\n  ownerNo VARCHAR(5) PRIMARY KEY,\n  fName VARCHAR(50) NOT NULL,\n  lName VARCHAR(50) NOT NULL,\n  address VARCHAR(100) NOT NULL,\n  telNo VARCHAR(15) NOT NULL,\n  email VARCHAR(100),\n  password VARCHAR(50) NOT NULL\n);",
      viewing: "CREATE TABLE Viewing (\n  clientNo VARCHAR(5) NOT NULL,\n  propertyNo VARCHAR(5) NOT NULL,\n  viewDate DATE NOT NULL,\n  comments TEXT,\n  PRIMARY KEY (clientNo, propertyNo, viewDate),\n  FOREIGN KEY (clientNo) REFERENCES Client(clientNo),\n  FOREIGN KEY (propertyNo) REFERENCES PropertyForRent(propertyNo)\n);"
    };

    const textareaId = {
      branch: "sqlBranch",
      staff: "sqlStaff",
      property: "sqlProperty",
      client: "sqlClient",
      owner: "sqlOwner",
      viewing: "sqlViewing"
    }[tableType];

    if (textareaId && solutions[tableType]) {
      document.getElementById(textareaId).value = solutions[tableType];
      // Add animation to show the solution was loaded
      const textarea = document.getElementById(textareaId);
      textarea.style.borderColor = "#2ecc71";
      setTimeout(() => {
        textarea.style.borderColor = "#ddd";
      }, 1000);
    }
  }
  </script>
</body>
</html>
