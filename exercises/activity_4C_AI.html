<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Activity 4C - AI SQL Checker</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 20px;
      max-width: 900px;
      margin: 0 auto;
      color: #333;
      background-color: #f5f7fa;
    }
    h1, h2 {
      color: #2c3e50;
    }
    h2 {
      border-bottom: 2px solid #3498db;
      padding-bottom: 8px;
      margin-top: 30px;
    }
    .container {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    textarea {
      width: 100%;
      height: 200px;
      font-family: 'Consolas', 'Monaco', monospace;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 4px;
      resize: vertical;
      font-size: 14px;
      margin: 10px 0;
    }
    textarea:focus {
      border-color: #3498db;
      outline: none;
    }
    button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px 5px 5px 0;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #2980b9;
    }
    button.secondary {
      background-color: #7f8c8d;
    }
    button.secondary:hover {
      background-color: #95a5a6;
    }
    .feedback {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-left: 4px solid #3498db;
      border-radius: 0 4px 4px 0;
      white-space: pre-wrap;
      font-family: 'Consolas', 'Monaco', monospace;
    }
    .feedback.error {
      border-left-color: #e74c3c;
      background: #fdedec;
    }
    .feedback.success {
      border-left-color: #2ecc71;
      background: #e8f8f0;
    }
    .table-list {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    .table-list p {
      margin: 5px 0;
      font-family: 'Consolas', 'Monaco', monospace;
    }
    .hidden {
      display: none;
    }
    .loading {
      color: #7f8c8d;
      font-style: italic;
    }
    .sql-keyword {
      color: #d03b3b;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>SweetHome Database Design</h1>
    <h2>Activity 4C: CREATE TABLE Statements</h2>
    
    <div class="table-list">
      <p><strong>Tables to implement:</strong></p>
      <p>a. Branch (<span class="sql-keyword">branchNo</span>, street, city, postcode)</p>
      <p>b. Staff (<span class="sql-keyword">staffNo</span>, fName, lName, position, gender, DOB, salary, <span class="sql-keyword">branchNo</span>)</p>
      <p>c. PropertyForRent (<span class="sql-keyword">propertyNo</span>, type, rooms, rent, <span class="sql-keyword">ownerNo</span>, <span class="sql-keyword">staffNo</span>, <span class="sql-keyword">branchNo</span>)</p>
      <p>d. Client (<span class="sql-keyword">clientNo</span>, fName, lName, telNo, prefType, maxRent, email)</p>
      <p>e. PrivateOwner (<span class="sql-keyword">ownerNo</span>, fName, lName, address, telNo, email, password)</p>
      <p>f. Viewing (<span class="sql-keyword">clientNo</span>, <span class="sql-keyword">propertyNo</span>, viewDate, comments)</p>
      <p><em>Note: Highlighted columns should be primary or foreign keys.</em></p>
    </div>

    <textarea id="userSQL" placeholder="Write your CREATE TABLE statements here...
Example:
CREATE TABLE Branch (
  branchNo VARCHAR(5) PRIMARY KEY,
  street VARCHAR(100) NOT NULL,
  city VARCHAR(50) NOT NULL,
  postcode VARCHAR(10) NOT NULL
);"></textarea>

    <div>
      <button onclick="checkWithAI()">‚úÖ Check with AI</button>
      <button onclick="showSolution()" class="secondary">üìã Show Solution</button>
      <button onclick="clearSQL()" class="secondary">üóëÔ∏è Clear</button>
    </div>

    <div id="aiFeedback" class="feedback"></div>
    <div id="solutionBox" class="feedback hidden"></div>
  </div>

  <script>
    async function checkWithAI() {
      const userSQL = document.getElementById("userSQL").value.trim();
      const feedbackBox = document.getElementById("aiFeedback");
      
      if (!userSQL) {
        feedbackBox.innerHTML = "<span class='error'>‚ùå Please enter some SQL code first.</span>";
        return;
      }

      feedbackBox.innerHTML = "<span class='loading'>‚è≥ Analyzing your SQL with AI... This may take 10-20 seconds.</span>";
      
      try {
        const response = await fetch("https://openrouter-proxy-k2ca.onrender.com/ai", {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            prompt: `You are an SQL expert grading a student's CREATE TABLE statements. Analyze this SQL for the SweetHome database:

${userSQL}

Provide:
1. Validation of syntax and constraints
2. Missing primary/foreign keys
3. Data type suggestions
4. A letter grade (A-F) with explanation
            
Format your response in HTML with headings.`
          })
        });

        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error);
        }

        // Handle both direct responses and OpenAI-style responses
        let aiResponse = data.choices?.[0]?.message?.content || data.message || data;
        
        feedbackBox.innerHTML = `<div class='success'>${aiResponse}</div>`;
        
      } catch (error) {
        console.error("AI Error:", error);
        feedbackBox.innerHTML = `<div class='error'>‚ùå AI Error: ${error.message || "Failed to get AI response"}</div>`;
      }
    }

    async function showSolution() {
      const solutionBox = document.getElementById("solutionBox");
      solutionBox.innerHTML = "<span class='loading'>‚è≥ Generating model solution...</span>";
      solutionBox.classList.remove("hidden");

      try {
        const response = await fetch("https://openrouter-proxy-k2ca.onrender.com/ai", {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            prompt: `Provide complete CREATE TABLE statements for the SweetHome database tables with all constraints:
            
1. Branch (branchNo, street, city, postcode)
2. Staff (staffNo, fName, lName, position, gender, DOB, salary, branchNo)
3. PropertyForRent (propertyNo, type, rooms, rent, ownerNo, staffNo, branchNo)
4. Client (clientNo, fName, lName, telNo, prefType, maxRent, email)
5. PrivateOwner (ownerNo, fName, lName, address, telNo, email, password)
6. Viewing (clientNo, propertyNo, viewDate, comments)
            
Include:
- PRIMARY KEY constraints
- FOREIGN KEY constraints
- Appropriate data types
- NOT NULL where needed
            
Format the response in SQL code blocks.`
          })
        });

        const data = await response.json();
        let solution = data.choices?.[0]?.message?.content || data.message || data;
        
        solutionBox.innerHTML = `<div><strong>Model Solution:</strong><pre>${solution}</pre></div>`;
        
      } catch (error) {
        solutionBox.innerHTML = `<div class='error'>‚ùå Failed to load solution: ${error.message}</div>`;
      }
    }

    function clearSQL() {
      document.getElementById("userSQL").value = "";
      document.getElementById("aiFeedback").innerHTML = "";
      document.getElementById("solutionBox").innerHTML = "";
      document.getElementById("solutionBox").classList.add("hidden");
    }
  </script>
</body>
</html>
