<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Activity 4C - AI SQL Checker</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 20px;
      max-width: 900px;
      margin: 0 auto;
      color: #333;
      background-color: #f5f7fa;
    }
    h1, h2 {
      color: #2c3e50;
    }
    h2 {
      border-bottom: 2px solid #3498db;
      padding-bottom: 8px;
      margin-top: 30px;
    }
    .table-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .table-header {
      font-weight: bold;
      margin-bottom: 10px;
      color: #2c3e50;
    }
    textarea {
      width: 100%;
      height: 120px;
      font-family: 'Consolas', 'Monaco', monospace;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 4px;
      resize: vertical;
      font-size: 14px;
      margin-bottom: 10px;
    }
    button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 8px 16px;
      margin-right: 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #2980b9;
    }
    .feedback {
      margin-top: 15px;
      padding: 12px;
      background: #f8f9fa;
      border-left: 4px solid #3498db;
      border-radius: 0 4px 4px 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .feedback.error {
      border-left-color: #e74c3c;
      background: #fdedec;
    }
    .feedback.success {
      border-left-color: #2ecc71;
      background: #e8f8f0;
    }
    .loading {
      color: #7f8c8d;
      font-style: italic;
    }
    .sql-keyword {
      color: #d03b3b;
      font-weight: bold;
    }
    .solution-btn {
      background-color: #7f8c8d;
    }
    .grade {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .grade-A { color: #2ecc71; }
    .grade-B { color: #27ae60; }
    .grade-C { color: #f39c12; }
    .grade-D { color: #e67e22; }
    .grade-F { color: #e74c3c; }
    .feedback-item {
      margin-bottom: 8px;
      padding-left: 24px;
      position: relative;
    }
    .feedback-item:before {
      position: absolute;
      left: 0;
      top: 2px;
    }
    .correct:before {
      content: " ";
    }
    .warning:before {
      content: " ";
    }
    .error:before {
      content: " ";
    }
    .suggestion:before {
      content: " ";
    }
  </style>
</head>
<body>
  <h1>SweetHome Database Design</h1>
  <h2>Activity 4C: CREATE TABLE Statements</h2>
  
  <!-- Branch Table -->
  <div class="table-card">
    <div class="table-header">a. Branch (<span class="sql-keyword">branchNo</span>, street, city, postcode)</div>
    <textarea id="sqlBranch" placeholder="CREATE TABLE Branch (
  branchNo VARCHAR(5) PRIMARY KEY,
  street VARCHAR(100) NOT NULL,
  city VARCHAR(50) NOT NULL,
  postcode VARCHAR(10) NOT NULL
);"></textarea>
    <button onclick="checkSQL('sqlBranch', 'feedbackBranch')">Check Branch</button>
    <button class="solution-btn" onclick="showSolution('branch')">Show Solution</button>
    <div id="feedbackBranch" class="feedback"></div>
  </div>

  <!-- Staff Table -->
  <div class="table-card">
    <div class="table-header">b. Staff (<span class="sql-keyword">staffNo</span>, fName, lName, position, gender, DOB, salary, <span class="sql-keyword">branchNo</span>)</div>
    <textarea id="sqlStaff" placeholder="CREATE TABLE Staff (
  staffNo VARCHAR(5) PRIMARY KEY,
  fName VARCHAR(50) NOT NULL,
  lName VARCHAR(50) NOT NULL,
  /* ... */
);"></textarea>
    <button onclick="checkSQL('sqlStaff', 'feedbackStaff')">Check Staff</button>
    <button class="solution-btn" onclick="showSolution('staff')">Show Solution</button>
    <div id="feedbackStaff" class="feedback"></div>
  </div>

  <!-- PropertyForRent Table -->
  <div class="table-card">
    <div class="table-header">c. PropertyForRent (<span class="sql-keyword">propertyNo</span>, type, rooms, rent, <span class="sql-keyword">ownerNo</span>, <span class="sql-keyword">staffNo</span>, <span class="sql-keyword">branchNo</span>)</div>
    <textarea id="sqlProperty" placeholder="CREATE TABLE PropertyForRent (
  propertyNo VARCHAR(5) PRIMARY KEY,
  /* ... */
);"></textarea>
    <button onclick="checkSQL('sqlProperty', 'feedbackProperty')">Check Property</button>
    <button class="solution-btn" onclick="showSolution('property')">Show Solution</button>
    <div id="feedbackProperty" class="feedback"></div>
  </div>

  <!-- Client Table -->
  <div class="table-card">
    <div class="table-header">d. Client (<span class="sql-keyword">clientNo</span>, fName, lName, telNo, prefType, maxRent, email)</div>
    <textarea id="sqlClient" placeholder="CREATE TABLE Client (
  clientNo VARCHAR(5) PRIMARY KEY,
  /* ... */
);"></textarea>
    <button onclick="checkSQL('sqlClient', 'feedbackClient')">Check Client</button>
    <button class="solution-btn" onclick="showSolution('client')">Show Solution</button>
    <div id="feedbackClient" class="feedback"></div>
  </div>

  <!-- PrivateOwner Table -->
  <div class="table-card">
    <div class="table-header">e. PrivateOwner (<span class="sql-keyword">ownerNo</span>, fName, lName, address, telNo, email, password)</div>
    <textarea id="sqlOwner" placeholder="CREATE TABLE PrivateOwner (
  ownerNo VARCHAR(5) PRIMARY KEY,
  /* ... */
);"></textarea>
    <button onclick="checkSQL('sqlOwner', 'feedbackOwner')">Check Owner</button>
    <button class="solution-btn" onclick="showSolution('owner')">Show Solution</button>
    <div id="feedbackOwner" class="feedback"></div>
  </div>

  <!-- Viewing Table -->
  <div class="table-card">
    <div class="table-header">f. Viewing (<span class="sql-keyword">clientNo</span>, <span class="sql-keyword">propertyNo</span>, viewDate, comments)</div>
    <textarea id="sqlViewing" placeholder="CREATE TABLE Viewing (
  /* Composite key? Foreign keys? */
);"></textarea>
    <button onclick="checkSQL('sqlViewing', 'feedbackViewing')">Check Viewing</button>
    <button class="solution-btn" onclick="showSolution('viewing')">Show Solution</button>
    <div id="feedbackViewing" class="feedback"></div>
  </div>

  <script>
  async function checkSQL(textareaId, feedbackId) {
    const sql = document.getElementById(textareaId).value.trim();
    const feedbackBox = document.getElementById(feedbackId);
    
    if (!sql) {
      feedbackBox.innerHTML = "<span class='error'>Please enter SQL first</span>";
      return;
    }

    feedbackBox.innerHTML = "<span class='loading'>‚è≥ Analyzing with AI...</span>";
    
    try {
      const response = await fetch("https://openrouter-proxy-k2ca.onrender.com/ai", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          messages: [
            {
              role: "user",
              content: `Analyze this SQL CREATE TABLE statement in MAX 5 bullet points. For each point use EMOJI + 1 sentence. End with letter grade (A-F). Format exactly like this example:

‚úÖ Primary key correctly defined
‚ö†Ô∏è Missing foreign key to staff table
‚ùå Phone number should be VARCHAR(15)
‚úÖ Good NOT NULL constraints
üí° Add branch_manager column

Grade: B

Here's the SQL to analyze:
${sql}`
            }
          ]
        })
      });

      if (!response.ok) {
        throw new Error(`Server error: ${response.status}`);
      }

      const data = await response.json();
      const aiResponse = data.choices?.[0]?.message?.content || "No analysis available";
      
      // Format the response
      const gradeMatch = aiResponse.match(/Grade: ([A-F])/i);
      const grade = gradeMatch ? gradeMatch[1] : '?';
      const feedbackContent = aiResponse.replace(/Grade: [A-F]/i, '').trim();
      
      feedbackBox.innerHTML = `
        <div class="grade grade-${grade}">Grade: ${grade}</div>
        ${feedbackContent.split('\n').map(line => {
          if (line.includes('‚úÖ')) return `<div class="feedback-item correct">${line}</div>`;
          if (line.includes('‚ö†Ô∏è')) return `<div class="feedback-item warning">${line}</div>`;
          if (line.includes('‚ùå')) return `<div class="feedback-item error">${line}</div>`;
          if (line.includes('üí°')) return `<div class="feedback-item suggestion">${line}</div>`;
          return `<div>${line}</div>`;
        }).join('')}
      `;
    } catch (error) {
      feedbackBox.innerHTML = `<div class="error">‚ùå Error: ${error.message || "Failed to get AI response"}</div>`;
    }
  }

    async function showSolution(tableType) {
      const solutions = {
        branch: "CREATE TABLE Branch (\n  branchNo VARCHAR(5) PRIMARY KEY,\n  street VARCHAR(100) NOT NULL,\n  city VARCHAR(50) NOT NULL,\n  postcode VARCHAR(10) NOT NULL\n);",
        staff: "CREATE TABLE Staff (\n  staffNo VARCHAR(5) PRIMARY KEY,\n  fName VARCHAR(50) NOT NULL,\n  lName VARCHAR(50) NOT NULL,\n  position VARCHAR(20) NOT NULL,\n  gender CHAR(1) CHECK (gender IN ('M', 'F')),\n  DOB DATE NOT NULL,\n  salary DECIMAL(10,2) NOT NULL,\n  branchNo VARCHAR(5) NOT NULL,\n  FOREIGN KEY (branchNo) REFERENCES Branch(branchNo)\n);",
        property: "CREATE TABLE PropertyForRent (\n  propertyNo VARCHAR(5) PRIMARY KEY,\n  type VARCHAR(20) NOT NULL,\n  rooms INT NOT NULL,\n  rent DECIMAL(10,2) NOT NULL,\n  ownerNo VARCHAR(5) NOT NULL,\n  staffNo VARCHAR(5),\n  branchNo VARCHAR(5) NOT NULL,\n  FOREIGN KEY (ownerNo) REFERENCES PrivateOwner(ownerNo),\n  FOREIGN KEY (staffNo) REFERENCES Staff(staffNo),\n  FOREIGN KEY (branchNo) REFERENCES Branch(branchNo)\n);",
        client: "CREATE TABLE Client (\n  clientNo VARCHAR(5) PRIMARY KEY,\n  fName VARCHAR(50) NOT NULL,\n  lName VARCHAR(50) NOT NULL,\n  telNo VARCHAR(15) NOT NULL,\n  prefType VARCHAR(20),\n  maxRent DECIMAL(10,2),\n  email VARCHAR(100)\n);",
        owner: "CREATE TABLE PrivateOwner (\n  ownerNo VARCHAR(5) PRIMARY KEY,\n  fName VARCHAR(50) NOT NULL,\n  lName VARCHAR(50) NOT NULL,\n  address VARCHAR(100) NOT NULL,\n  telNo VARCHAR(15) NOT NULL,\n  email VARCHAR(100),\n  password VARCHAR(50) NOT NULL\n);",
        viewing: "CREATE TABLE Viewing (\n  clientNo VARCHAR(5) NOT NULL,\n  propertyNo VARCHAR(5) NOT NULL,\n  viewDate DATE NOT NULL,\n  comments TEXT,\n  PRIMARY KEY (clientNo, propertyNo, viewDate),\n  FOREIGN KEY (clientNo) REFERENCES Client(clientNo),\n  FOREIGN KEY (propertyNo) REFERENCES PropertyForRent(propertyNo)\n);"
      };

      const feedbackId = `feedback${tableType.charAt(0).toUpperCase() + tableType.slice(1)}`;
      document.getElementById(feedbackId).innerHTML = `<div class='success'><strong>Solution:</strong><pre>${solutions[tableType]}</pre></div>`;
    }
  </script>
</body>
</html>
